name: Build Compiler and Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Haxe environment
      uses: krdlab/setup-haxe@v1.5.1
      with:
        haxe-version: 4.3.1
    - name: Install hxcpp
      run: haxelib install hxcpp
    - name: Build Compiler
      run: haxe Release.hxml
    - name: Move Compiler
      run: mv ./Binary/cpp/Main ./ALCL
    - name: List Files
      run: ls
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: alcl-linux
        path: ./ALCL
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Haxe environment
        uses: krdlab/setup-haxe@v1.5.1
        with:
          haxe-version: 4.3.1
      - name: Install hxcpp
        run: haxelib install hxcpp
      - name: Build Compiler
        run: haxe Release.hxml
      - name: Move Compiler
        run: mv ./Binary/cpp/Main.exe ./ALCL.exe
      - name: List Files
        run: dir
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: alcl-windows
          path: ./ALCL.exe
  run-tests-linux:
    runs-on: ubuntu-latest
    needs: build-linux
    steps:
      - name: Download repository
        uses: actions/checkout@v4
      - name: Download compiled file
        uses: actions/download-artifact@v4
        with:
          name: alcl-linux
      - name: Generate Tests
        run: |
          chmod +x ./ALCL
          chmod +x ./Scripts/git_test_linux.sh
          ./Scripts/git_test_linux.sh
      - name: File Tree
        run: tree
      - name: Run Tests
        run:
          cd ./Env/Out/Tests/build
          chmod +x ./output
          ./output